import numpy as np
import matplotlib.pyplot as plt
from scipy.linalg import solve_banded

# Заданные параметры
Kx = 24.8  # Коэффициент турбулентной диффузии
Vx = 8.09  # Скорость ветра
f = 0.66  # Мощность источника
Lx = 40  # Длина области расчета
dx = 10  # Величина пространственного шага
dt = 1  # Временной шаг
t_max = 5  # Общее время

# Число узлов сетки
Nx = Lx // dx + 1
Nt = t_max // dt + 1

# Сетка по x
x = np.linspace(0, Lx, Nx)

# Инициализация массива концентраций
C = np.zeros(Nx)

# Численные коэффициенты
r = Kx * dt / (2 * dx**2)
p = Vx * dt / (4 * dx)

# Матрицы для метода Кранка-Николсона
A = np.zeros((3, Nx))
B = np.zeros((3, Nx))

# Заполняем матрицы
for i in range(1, Nx - 1):
    A[1, i] = 1 + 2 * r  # Главная диагональ
    A[0, i] = -r + p  # Верхняя диагональ
    A[2, i] = -r - p  # Нижняя диагональ
    B[1, i] = 1 - 2 * r  # Главная диагональ
    B[0, i] = r - p  # Верхняя диагональ
    B[2, i] = r + p  # Нижняя диагональ

# Граничные условия (неизменные)
A[1, 0] = A[1, -1] = 1
B[1, 0] = B[1, -1] = 1

# Итерационный процесс по времени
for n in range(1, Nt):
    # Вычисляем правую часть системы
    C_rhs = B[1] * C + B[0] * np.roll(C, -1) + B[2] * np.roll(C, 1)
    C_rhs[0] += f * dt / dx  # Источник в x=0

    # Решаем систему уравнений
    C = solve_banded((1, 1), A, C_rhs)

# Построение графика
plt.figure(figsize=(8, 5))
plt.plot(
    x, C, marker="o", linestyle="-", color="b", label=f"Распределение через {t_max} с"
)
plt.xlabel("Расстояние (м)")
plt.ylabel("Концентрация примеси")
plt.title("Распределение концентрации примеси")
plt.legend()
plt.grid()
plt.show()
